esphome:
  name: waveshare-s3-7
  friendly_name: "Waveshare S3 7\""
  min_version: 2024.10.0

esp32:
  board: esp32-s3-devkitc-1
  variant: esp32s3
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_MBEDTLS_CERTIFICATE_BUNDLE: n
      # Enable better crash reporting - print panic info then reboot
      CONFIG_ESP_SYSTEM_PANIC_PRINT_REBOOT: y
      CONFIG_ESP_SYSTEM_PANIC_GDBSTUB: n
      # Enable stack overflow detection
      CONFIG_ESP_MAIN_TASK_STACK_SIZE: "8192"
      CONFIG_ESP_TASK_WDT_TIMEOUT_S: "10"
      CONFIG_ESP_TASK_WDT_CHECK_IDLE_TASK_CPU0: y
      CONFIG_ESP_TASK_WDT_CHECK_IDLE_TASK_CPU1: y

logger:
  level: DEBUG
  logs:
    "*": DEBUG
    "lvgl": DEBUG
    "display": DEBUG
ota:
  - platform: esphome
api:

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "Waveshare-Setup"
    password: "changeme123"

time:
  - platform: sntp
    id: sntp_time
    timezone: Europe/Oslo

# Global temperature history storage
globals:
  - id: temp_history
    type: std::vector<float>
    restore_value: false

interval:
  - interval: 1s
    then:
      - lambda: |-
          ESP_LOGD("main", "Clock update tick");
          auto now = id(sntp_time).now();
          auto *label = id(lbl_clock);
          if (!now.is_valid()) {
            lv_label_set_text(label, "--:--");
          } else {
            auto text = now.strftime("%H:%M");
            lv_label_set_text(label, text.c_str());
          }
  - interval: 1h
    then:
      - lambda: |-
          // Update chart every hour - 24 hours of history
          ESP_LOGD("chart", "Chart update started");
          
          if (!id(mqtt_temperature).has_state()) {
            ESP_LOGD("chart", "No temperature state");
            return;
          }
          
          float temp = id(mqtt_temperature).state;
          ESP_LOGD("chart", "Temperature: %.1f", temp);
          
          // Add to history (keep last 24 points = 24 hours)
          id(temp_history).push_back(temp);
          if (id(temp_history).size() > 24) {
            id(temp_history).erase(id(temp_history).begin());
          }
          
          ESP_LOGD("chart", "History size: %d", id(temp_history).size());
          
          // Skip drawing if no data
          if (id(temp_history).size() == 0) {
            ESP_LOGD("chart", "No history data");
            return;
          }
          
          // Get canvas
          auto *canvas = id(chart_temperature);
          if (!canvas) {
            ESP_LOGE("chart", "Canvas is null!");
            return;
          }
          
          ESP_LOGD("chart", "Canvas found, calculating min/max");
          
          // Find min/max for scaling
          float min_val = id(temp_history)[0];
          float max_val = id(temp_history)[0];
          for (size_t i = 0; i < id(temp_history).size() && i < 24; i++) {
            float val = id(temp_history)[i];
            if (val < min_val) min_val = val;
            if (val > max_val) max_val = val;
          }
          
          float range = max_val - min_val;
          if (range < 0.1f) {
            min_val -= 0.5f;
            max_val += 0.5f;
            range = max_val - min_val;
          }
          
          ESP_LOGD("chart", "Range: %.1f to %.1f", min_val, max_val);
          
          // Clear and redraw - simple approach
          ESP_LOGD("chart", "Clearing canvas");
          lv_draw_rect_dsc_t rect_dsc;
          lv_draw_rect_dsc_init(&rect_dsc);
          rect_dsc.bg_color = lv_color_hex(0x1a1a1c);
          lv_canvas_draw_rect(canvas, 0, 0, 248, 165, &rect_dsc);
          
          ESP_LOGD("chart", "Drawing grid");
          // Draw grid
          lv_draw_line_dsc_t grid_dsc;
          lv_draw_line_dsc_init(&grid_dsc);
          grid_dsc.color = lv_color_hex(0x2A2D32);
          grid_dsc.width = 1;
          for (int i = 0; i <= 4; i++) {
            int y = 15 + (i * 135 / 4);
            lv_point_t pts[2] = {{10, (lv_coord_t)y}, {238, (lv_coord_t)y}};
            lv_canvas_draw_line(canvas, pts, 2, &grid_dsc);
          }
          
          ESP_LOGD("chart", "Drawing chart");
          size_t count = id(temp_history).size();
          if (count > 24) count = 24;
          
          ESP_LOGD("chart", "Drawing %d points", count);
          
          if (count == 0) {
            return;
          }
          
          // Calculate all point positions first
          int x_coords[24];
          int y_coords[24];
          
          for (size_t i = 0; i < count; i++) {
            int x = 10 + (int)(i * 228 / ((count > 1) ? (count - 1) : 1));
            if (x < 10) x = 10;
            if (x > 238) x = 238;
            
            float val = id(temp_history)[i];
            float norm = (val - min_val) / range;
            int y = 150 - (int)(norm * 135.0f);
            if (y < 15) y = 15;
            if (y > 150) y = 150;
            
            x_coords[i] = x;
            y_coords[i] = y;
          }
          
          // Draw lines connecting the points
          if (count > 1) {
            ESP_LOGD("chart", "Drawing lines");
            lv_draw_line_dsc_t line_dsc;
            lv_draw_line_dsc_init(&line_dsc);
            line_dsc.color = lv_color_hex(0x27BAFD);
            line_dsc.width = 2;
            
            for (size_t i = 0; i < count - 1; i++) {
              lv_point_t line_points[2] = {
                {(lv_coord_t)x_coords[i], (lv_coord_t)y_coords[i]},
                {(lv_coord_t)x_coords[i + 1], (lv_coord_t)y_coords[i + 1]}
              };
              lv_canvas_draw_line(canvas, line_points, 2, &line_dsc);
            }
          }
          
          // Draw dots on top of the lines
          ESP_LOGD("chart", "Drawing dots");
          lv_draw_rect_dsc_t dot_dsc;
          lv_draw_rect_dsc_init(&dot_dsc);
          dot_dsc.bg_color = lv_color_hex(0x27BAFD);
          
          for (size_t i = 0; i < count; i++) {
            lv_canvas_draw_rect(canvas, x_coords[i] - 2, y_coords[i] - 2, 4, 4, &dot_dsc);
          }
          
          ESP_LOGD("chart", "Invalidating canvas");
          lv_obj_invalidate(canvas);
          ESP_LOGD("chart", "Chart update complete");

psram:
  mode: octal
  speed: 80MHz

# --- MQTT (Homey/HA bridge) ---
mqtt:
  id: mqtt_client
  broker: !secret mqtt_host
  username: !secret mqtt_user
  password: !secret mqtt_pass
  discovery: false
  birth_message:
    topic: home/waveshare7/availability
    payload: online
  will_message:
    topic: home/waveshare7/availability
    payload: offline

# --- MQTT Text Sensors for Light Status ---
text_sensor:
  - platform: mqtt_subscribe
    name: "Lys ved TV Status"
    id: mqtt_lys_ved_tv_status
    topic: "homie/5/488fedd6-ef91-464e-afe3-d2b83f6e4250/main/onoff"
    on_value:
      - lambda: |-
          bool is_on = (x == "true");
          auto *btn = id(btn_lys_ved_tv);
          if (is_on) {
            lv_obj_add_state(btn, LV_STATE_CHECKED);
          } else {
            lv_obj_clear_state(btn, LV_STATE_CHECKED);
          }
          auto *icon = id(icon_lys_ved_tv);
          lv_obj_set_style_text_color(icon, lv_color_hex(is_on ? 0xFFFF00 : 0xFFFFFF), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
  - platform: mqtt_subscribe
    name: "Snowball Status"
    id: mqtt_snowball_status
    topic: "homie/5/f3b5872d-e02d-4334-b36a-339c2610d063/main/onoff"
    on_value:
      - lambda: |-
          bool is_on = (x == "true");
          auto *btn = id(btn_snowball);
          if (is_on) {
            lv_obj_add_state(btn, LV_STATE_CHECKED);
          } else {
            lv_obj_clear_state(btn, LV_STATE_CHECKED);
          }
          auto *icon = id(icon_snowball);
          lv_obj_set_style_text_color(icon, lv_color_hex(is_on ? 0xFFFF00 : 0xFFFFFF), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
  - platform: mqtt_subscribe
    name: "Sofa Status"
    id: mqtt_sofa_status
    topic: "homie/5/6019e7c5-7c2f-4a57-9ccd-2ab81e03b51b/main/onoff"
    on_value:
      - lambda: |-
          bool is_on = (x == "true");
          auto *btn = id(btn_sofa);
          if (is_on) {
            lv_obj_add_state(btn, LV_STATE_CHECKED);
          } else {
            lv_obj_clear_state(btn, LV_STATE_CHECKED);
          }
          auto *icon = id(icon_sofa);
          lv_obj_set_style_text_color(icon, lv_color_hex(is_on ? 0xFFFF00 : 0xFFFFFF), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
  - platform: mqtt_subscribe
    name: "Ved Kaffemaskin Status"
    id: mqtt_ved_kaffemaskin_status
    topic: "homie/5/ade7d274-e4ec-451b-9e55-e422f6a33fce/main/onoff"
    on_value:
      - lambda: |-
          bool is_on = (x == "true");
          auto *btn = id(btn_ved_kaffemaskin);
          if (is_on) {
            lv_obj_add_state(btn, LV_STATE_CHECKED);
          } else {
            lv_obj_clear_state(btn, LV_STATE_CHECKED);
          }
          auto *icon = id(icon_ved_kaffemaskin);
          lv_obj_set_style_text_color(icon, lv_color_hex(is_on ? 0xFFFF00 : 0xFFFFFF), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
  - platform: mqtt_subscribe
    name: "Taklys Status 1"
    id: mqtt_taklys_status_1
    topic: "homie/5/5407dde9-15d9-4935-baa5-3bdcfa80e515/main/onoff"
    on_value:
      - lambda: |-
          bool is_on = (x == "true");
          auto *btn = id(btn_taklys);
          bool status2 = id(mqtt_taklys_status_2).has_state() && (id(mqtt_taklys_status_2).state == "true");
          bool should_be_checked = is_on || status2;
          if (should_be_checked) {
            lv_obj_add_state(btn, LV_STATE_CHECKED);
          } else {
            lv_obj_clear_state(btn, LV_STATE_CHECKED);
          }
          auto *icon = id(icon_taklys);
          lv_obj_set_style_text_color(icon, lv_color_hex(should_be_checked ? 0xFFFF00 : 0xFFFFFF), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
  - platform: mqtt_subscribe
    name: "Taklys Status 2"
    id: mqtt_taklys_status_2
    topic: "homie/5/70b068f8-9033-4bff-a7e9-253cc502b571/main/onoff"
    on_value:
      - lambda: |-
          bool is_on = (x == "true");
          auto *btn = id(btn_taklys);
          bool status1 = id(mqtt_taklys_status_1).has_state() && (id(mqtt_taklys_status_1).state == "true");
          bool should_be_checked = is_on || status1;
          if (should_be_checked) {
            lv_obj_add_state(btn, LV_STATE_CHECKED);
          } else {
            lv_obj_clear_state(btn, LV_STATE_CHECKED);
          }
          auto *icon = id(icon_taklys);
          lv_obj_set_style_text_color(icon, lv_color_hex(should_be_checked ? 0xFFFF00 : 0xFFFFFF), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));

# --- MQTT Temperature Sensor ---
sensor:
  - platform: mqtt_subscribe
    name: "Temperature"
    id: mqtt_temperature
    topic: "homie/5/95677a74-cdf4-451a-8a18-a2fe7ac8351d/main/measure_temperature"
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    state_class: measurement
    on_value:
      - lambda: |-
          // Update temperature label on every value change
          float temp = x;
          char temp_str[16];
          snprintf(temp_str, sizeof(temp_str), "%.1f°C", temp);
          lv_label_set_text(id(lbl_temperature), temp_str);
          
          // Note: Chart updates are handled by the 1-minute interval
          // This callback just updates the label

# --- I2C for GT911 + CH422G ---
i2c:
  sda: GPIO8
  scl: GPIO9
  id: bus_main
  frequency: 400kHz

# --- CH422G IO expander ---
ch422g:
  id: io_ex

# --- Touchscreen (GT911) ---
touchscreen:
  platform: gt911
  id: gt
  interrupt_pin: GPIO4
  reset_pin:
    ch422g: io_ex
    number: 1

# --- Display (Waveshare ESP32-S3 Touch LCD 7") ---
display:
  - platform: mipi_rgb
    id: panel
    model: ESP32-S3-TOUCH-LCD-7-800X480
    enable_pin:
      ch422g: io_ex
      number: 2

# ================================
#           FONTS
# ================================
# Use ESPHome's standard font component (works with LVGL).
font:
  - file: "gfonts://Roboto"
    id: font_clock
    size: 72
  - file: "gfonts://Roboto"
    id: font_heading
    size: 32
  - file: "gfonts://Roboto"
    id: chart_heading
    size: 20
  - file: "gfonts://Roboto"
    id: font_button_text
    size: 16
  - file: "fonts/fa-solid-900.ttf"
    id: font_button_icon
    size: 16
    bpp: 4
    # Include only the glyphs we use (TV, Lightbulb, Music, Arrow Up, Arrow Down)
    glyphs:
      - "\uF26C"
      - "\uF0EB"
      - "\uF0C2"
      - "\uF001"
      - "\uF062"
      - "\uF063"
  - file: "fonts/fa-solid-900.ttf"
    id: fa_48
    size: 48
    bpp: 4
    # Include only the glyphs we use (Lightbulb)
    glyphs:
      - "\uF0EB"

# ================================
#           LVGL UI
# ================================
lvgl:
  id: ui
  touchscreens: [gt]

  pages:
    - id: page_main
      bg_color: 0x000000  # dashboard background
      widgets:
        # Left panel (30%)
        - obj:
            id: panel_left
            width: 240
            height: 480
            align: left_mid
            bg_color: 0x000000
            border_width: 0
            pad_top: 16
            pad_bottom: 16
            pad_left: 16
            pad_right: 16
            scrollbar_mode: "off"
            widgets:
              - label:
                  id: lbl_clock
                  text: "--:--"
                  text_font: font_clock
                  text_color: 0xFFFFFF
                  align: top_mid
                  y: 0
              - obj:
                  id: panel_left_buttons
                  width: 100%
                  height: 360
                  align: top_left
                  y: 100
                  bg_color: 0x000000
                  bg_opa: 100%
                  border_width: 0
                  scrollbar_mode: "off"
                  layout:
                    type: flex
                    flex_flow: column
                    flex_align_main: start
                    flex_align_cross: start
                    pad_row: 16
                  widgets:
                    # Button: TV
                    - button:
                        id: btn_tv
                        width: 100%
                        height: 64
                        bg_color: 0x000000
                        border_color: 0x2A2D32
                        border_width: 2
                        radius: 12
                        shadow_width: 0
                        outline_width: 0
                        pad_left: 16
                        pad_right: 16
                        pad_top: 12
                        pad_bottom: 12
                        on_boot:
                          - lambda: |-
                              auto *btn = id(btn_tv);
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x27BAFD), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x27BAFD), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                        on_click:
                          - mqtt.publish:
                              topic: /stemning/loft
                              payload: "TV"
                        widgets:
                          - label:
                              text: "\uF26C"
                              text_font: font_button_icon
                              text_color: 0xFFFFFF
                              align: left_mid
                              x: 0
                          - label:
                              text: "TV"
                              text_font: font_button_text
                              text_color: 0xC8CDD2
                              align: left_mid
                              x: 48
                    # Button: Kveld
                    - button:
                        id: btn_kveld
                        width: 100%
                        height: 64
                        bg_color: 0x000000
                        border_color: 0x2A2D32
                        border_width: 2
                        radius: 12
                        shadow_width: 0
                        outline_width: 0
                        pad_left: 16
                        pad_right: 16
                        pad_top: 12
                        pad_bottom: 12
                        on_boot:
                          - lambda: |-
                              auto *btn = id(btn_kveld);
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x27BAFD), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x27BAFD), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                        on_click:
                          - mqtt.publish:
                              topic: /stemning/loft
                              payload: "Kveld"
                        widgets:
                          - label:
                              text: "\uF0EB"
                              text_font: font_button_icon
                              text_color: 0xFFFFFF
                              align: left_mid
                              x: 0
                          - label:
                              text: "Kveld"
                              text_font: font_button_text
                              text_color: 0xC8CDD2
                              align: left_mid
                              x: 48
                    # Button: Lys
                    - button:
                        id: btn_lys
                        width: 100%
                        height: 64
                        bg_color: 0x000000
                        border_color: 0x2A2D32
                        border_width: 2
                        radius: 12
                        shadow_width: 0
                        outline_width: 0
                        pad_left: 16
                        pad_right: 16
                        pad_top: 12
                        pad_bottom: 12
                        on_boot:
                          - lambda: |-
                              auto *btn = id(btn_lys);
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x27BAFD), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x27BAFD), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                        on_click:
                          - mqtt.publish:
                              topic: /stemning/loft
                              payload: "Les"
                        widgets:
                          - label:
                              text: "\uF001"
                              text_font: font_button_icon
                              text_color: 0xFFFFFF
                              align: left_mid
                              x: 0
                          - label:
                              text: "Lys"
                              text_font: font_button_text
                              text_color: 0xC8CDD2
                              align: left_mid
                              x: 48
        # Right panel (70%) - split into two panels
        # Right panel left half (50%)
        - obj:
            id: panel_right_left
            width: 280
            height: 480
            align: left_mid
            x: 240
            bg_color: 0x1a1a1c
            border_width: 0
            radius: 0
            pad_all: 16
            scrollbar_mode: "off"
            widgets:
              # Heading: "Lys"
              - label:
                  text: "Lys"
                  text_font: font_heading
                  text_color: 0xFFFFFF
                  align: top_mid
                  y: 0
              # Buttons container with flex layout
              - obj:
                  id: panel_right_left_buttons
                  width: 100%
                  height: 400
                  align: top_left
                  y: 60
                  bg_color: 0x1a1a1c
                  border_width: 0
                  scrollbar_mode: "off"
                  layout:
                    type: flex
                    flex_flow: row_wrap
                    flex_align_main: space_evenly
                    flex_align_cross: start
                    flex_align_track: start
                    pad_row: 16
                    pad_column: 16
                  widgets:
                    # Button 1: Lys ved TV
                    - button:
                        id: btn_lys_ved_tv
                        width: 100
                        height: 100
                        bg_color: 0x1a1a1c
                        border_width: 0
                        outline_width: 0
                        radius: 50
                        clip_corner: false
                        checkable: true
                        on_boot:
                          - lambda: |-
                              auto *btn = id(btn_lys_ved_tv);
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x1a1a1c), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x1a1a1c), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x1a1a1c), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_border_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_border_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_border_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                        on_click:
                          - lambda: |-
                              bool checked = lv_obj_has_state(id(btn_lys_ved_tv), LV_STATE_CHECKED);
                              std::string payload = checked ? "true" : "false";
                              id(mqtt_client).publish("homie/5/488fedd6-ef91-464e-afe3-d2b83f6e4250/main/onoff/set", payload, 0, false);
                              auto *icon = id(icon_lys_ved_tv);
                              lv_obj_set_style_text_color(icon, lv_color_hex(checked ? 0xFFFF00 : 0xFFFFFF), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                        widgets:
                          - label:
                              id: icon_lys_ved_tv
                              text: "\uF0EB"
                              text_font: fa_48
                              text_color: 0xFFFFFF
                              align: center
                              y: -20
                          - label:
                              text: "Lys ved TV"
                              text_font: font_button_text
                              text_color: 0xC8CDD2
                              align: bottom_mid
                              y: -8
                    # Button 2: Snowball
                    - button:
                        id: btn_snowball
                        width: 100
                        height: 100
                        bg_color: 0x1a1a1c
                        border_width: 0
                        outline_width: 0
                        radius: 50
                        clip_corner: false
                        checkable: true
                        on_boot:
                          - lambda: |-
                              auto *btn = id(btn_snowball);
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x1a1a1c), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x1a1a1c), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x1a1a1c), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_border_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_border_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_border_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                        on_click:
                          - lambda: |-
                              bool checked = lv_obj_has_state(id(btn_snowball), LV_STATE_CHECKED);
                              std::     string payload = checked ? "true" : "false";
                              id(mqtt_client).publish("homie/5/f3b5872d-e02d-4334-b36a-339c2610d063/main/onoff/set", payload, 0, false);
                              auto *icon = id(icon_snowball);
                              lv_obj_set_style_text_color(icon, lv_color_hex(checked ? 0xFFFF00 : 0xFFFFFF), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                        widgets:
                          - label:
                              id: icon_snowball
                              text: "\uF0EB"
                              text_font: fa_48
                              text_color: 0xFFFFFF
                              align: center
                              y: -20
                          - label:
                              text: "Snowball"
                              text_font: font_button_text
                              text_color: 0xC8CDD2
                              align: bottom_mid
                              y: -8
                    # Button 3: Sofa
                    - button:
                        id: btn_sofa
                        width: 100
                        height: 100
                        bg_color: 0x1a1a1c
                        border_width: 0
                        outline_width: 0
                        radius: 50
                        clip_corner: false
                        checkable: true
                        on_boot:
                          - lambda: |-
                              auto *btn = id(btn_sofa);
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x1a1a1c), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x1a1a1c), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x1a1a1c), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_border_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_border_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_border_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                        on_click:
                          - lambda: |-
                              bool checked = lv_obj_has_state(id(btn_sofa), LV_STATE_CHECKED);
                              std::string payload = checked ? "true" : "false";
                              id(mqtt_client).publish("homie/5/6019e7c5-7c2f-4a57-9ccd-2ab81e03b51b/main/onoff/set", payload, 0, false);
                              auto *icon = id(icon_sofa);
                              lv_obj_set_style_text_color(icon, lv_color_hex(checked ? 0xFFFF00 : 0xFFFFFF), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                        widgets:
                          - label:
                              id: icon_sofa
                              text: "\uF0EB"
                              text_font: fa_48
                              text_color: 0xFFFFFF
                              align: center
                              y: -20
                          - label:
                              text: "Sofa"
                              text_font: font_button_text
                              text_color: 0xC8CDD2
                              align: bottom_mid
                              y: -8
                    # Button 4: Ved Kaffemaskin
                    - button:
                        id: btn_ved_kaffemaskin
                        width: 100
                        height: 100
                        bg_color: 0x1a1a1c
                        border_width: 0
                        outline_width: 0
                        radius: 50
                        clip_corner: false
                        checkable: true
                        on_boot:
                          - lambda: |-
                              auto *btn = id(btn_ved_kaffemaskin);
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x1a1a1c), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x1a1a1c), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x1a1a1c), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_border_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_border_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_border_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                        on_click:
                          - lambda: |-
                              bool checked = lv_obj_has_state(id(btn_ved_kaffemaskin), LV_STATE_CHECKED);
                              std::string payload = checked ? "true" : "false";
                              id(mqtt_client).publish("homie/5/ade7d274-e4ec-451b-9e55-e422f6a33fce/main/onoff/set", payload, 0, false);
                              auto *icon = id(icon_ved_kaffemaskin);
                              lv_obj_set_style_text_color(icon, lv_color_hex(checked ? 0xFFFF00 : 0xFFFFFF), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                        widgets:
                          - label:
                              id: icon_ved_kaffemaskin
                              text: "\uF0EB"
                              text_font: fa_48
                              text_color: 0xFFFFFF
                              align: center
                              y: -20
                          - label:
                              text: "Kaffemaskin"
                              text_font: font_button_text
                              text_color: 0xC8CDD2
                              align: bottom_mid
                              y: -8
                    # Button 5: Taklys (needs to publish to 2 topics)
                    - button:
                        id: btn_taklys
                        width: 100
                        height: 100
                        bg_color: 0x1a1a1c
                        border_width: 0
                        outline_width: 0
                        radius: 50
                        clip_corner: false
                        checkable: true
                        on_boot:
                          - lambda: |-
                              auto *btn = id(btn_taklys);
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x1a1a1c), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x1a1a1c), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x1a1a1c), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_border_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_border_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_border_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_CHECKED));
                        on_click:
                          - lambda: |-
                              bool checked = lv_obj_has_state(id(btn_taklys), LV_STATE_CHECKED);
                              std::string payload = checked ? "true" : "false";
                              id(mqtt_client).publish("homie/5/5407dde9-15d9-4935-baa5-3bdcfa80e515/main/onoff/set", payload, 0, false);
                              id(mqtt_client).publish("homie/5/70b068f8-9033-4bff-a7e9-253cc502b571/main/onoff/set", payload, 0, false);
                              auto *icon = id(icon_taklys);
                              lv_obj_set_style_text_color(icon, lv_color_hex(checked ? 0xFFFF00 : 0xFFFFFF), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                        widgets:
                          - label:
                              id: icon_taklys
                              text: "\uF0EB"
                              text_font: fa_48
                              text_color: 0xFFFFFF
                              align: center
                              y: -20
                          - label:
                              text: "Taklys"
                              text_font: font_button_text
                              text_color: 0xC8CDD2
                              align: bottom_mid
                              y: -8
        # Right panel right half (50%)
        - obj:
            id: panel_right_right
            width: 280
            height: 480
            align: right_mid
            bg_color: 0x1a1a1c
            border_width: 0
            radius: 0
            pad_all: 16
            scrollbar_mode: "off"
            clip_corner: false
            on_boot:
              - lambda: |-
                  auto *panel = id(panel_right_right);
                  lv_obj_set_scroll_dir(panel, LV_DIR_NONE);
                  lv_obj_clear_flag(panel, LV_OBJ_FLAG_SCROLLABLE);
            widgets:
              # Heading: "Rullegardiner"
              - label:
                  text: "Rullegardiner"
                  text_font: font_heading
                  text_color: 0xFFFFFF
                  align: top_mid
                  y: 0
              # Buttons container with flex layout
              - obj:
                  id: panel_right_right_buttons
                  width: 100%
                  height: 84
                  align: top_left
                  y: 60
                  bg_color: 0x1a1a1c
                  border_width: 0
                  scrollbar_mode: "off"
                  clip_corner: false
                  on_boot:
                    - lambda: |-
                        auto *container = id(panel_right_right_buttons);
                        lv_obj_set_scroll_dir(container, LV_DIR_NONE);
                        lv_obj_clear_flag(container, LV_OBJ_FLAG_SCROLLABLE);
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: space_evenly
                    flex_align_cross: start
                    pad_row: 0
                    pad_column: 8
                  widgets:
                    # Button: Opp
                    - button:
                        id: btn_rullegardiner_opp
                        width: 48%
                        height: 64
                        bg_color: 0x1a1a1c
                        border_color: 0x2A2D32
                        border_width: 2
                        radius: 12
                        shadow_width: 0
                        outline_width: 0
                        pad_left: 16
                        pad_right: 16
                        pad_top: 12
                        pad_bottom: 12
                        on_boot:
                          - lambda: |-
                              auto *btn = id(btn_rullegardiner_opp);
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x27BAFD), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                        on_click:
                          - lambda: |-
                              std::string payload = "1";
                              id(mqtt_client).publish("homie/5/395607c8-d444-41d4-90e9-3de7ee364ff4/main/windowcoverings_set/set", payload, 0, false);
                              id(mqtt_client).publish("homie/5/a3c22c40-c730-4546-a797-16ba446e2bb5/main/windowcoverings_set/set", payload, 0, false);
                        widgets:
                          - label:
                              text: "\uF062"
                              text_font: font_button_icon
                              text_color: 0xFFFFFF
                              align: left_mid
                              x: 0
                          - label:
                              text: "Opp"
                              text_font: font_button_text
                              text_color: 0xC8CDD2
                              align: left_mid
                              x: 32
                    # Button: Ned
                    - button:
                        id: btn_rullegardiner_ned
                        width: 48%
                        height: 64
                        bg_color: 0x1a1a1c
                        border_color: 0x2A2D32
                        border_width: 2
                        radius: 12
                        shadow_width: 0
                        outline_width: 0
                        pad_left: 16
                        pad_right: 16
                        pad_top: 12
                        pad_bottom: 12
                        on_boot:
                          - lambda: |-
                              auto *btn = id(btn_rullegardiner_ned);
                              lv_obj_set_style_bg_color(btn, lv_color_hex(0x27BAFD), (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_shadow_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_DEFAULT));
                              lv_obj_set_style_outline_width(btn, 0, (lv_part_t)((uint32_t)LV_PART_MAIN | (uint32_t)LV_STATE_PRESSED));
                        on_click:
                          - lambda: |-
                              std::string payload = "0";
                              id(mqtt_client).publish("homie/5/395607c8-d444-41d4-90e9-3de7ee364ff4/main/windowcoverings_set/set", payload, 0, false);
                              id(mqtt_client).publish("homie/5/a3c22c40-c730-4546-a797-16ba446e2bb5/main/windowcoverings_set/set", payload, 0, false);
                        widgets:
                          - label:
                              text: "\uF063"
                              text_font: font_button_icon
                              text_color: 0xFFFFFF
                              align: left_mid
                              x: 0
                          - label:
                              text: "Ned"
                              text_font: font_button_text
                              text_color: 0xC8CDD2
                              align: left_mid
                              x: 32
              # Temperature section
              - obj:
                  id: temp_header
                  width: 100%
                  align: top_mid
                  y: 164
                  bg_color: 0x1a1a1c
                  border_width: 0
                  scrollbar_mode: "off"
                  clip_corner: false
                  on_boot:
                    - lambda: |-
                        auto *header = id(temp_header);
                        lv_obj_set_scroll_dir(header, LV_DIR_NONE);
                        lv_obj_clear_flag(header, LV_OBJ_FLAG_SCROLLABLE);
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: center
                    flex_align_cross: center
                  widgets:
                    - label:
                        text: "Temperatur"
                        text_font: chart_heading
                        text_color: 0xFFFFFF
                        align: center
                    - label:
                        id: lbl_temperature
                        text: "--°C"
                        text_font: chart_heading
                        text_color: 0xFFFFFF
                        align: center
                        x: 8
              - canvas:
                  id: chart_temperature
                  width: 248
                  height: 165
                  align: top_mid
                  y: 212
                  bg_color: 0x1a1a1c
                  border_color: 0x2A2D32
                  border_width: 2
                  radius: 12
                  on_boot:
                    - lambda: |-
                        // TEMPORARILY DISABLED - Testing if canvas causes crash
                        // Initialize canvas buffer with debug logging
                        ESP_LOGI("canvas", "=== Canvas boot initialization started ===");
                        delay(500); // Longer delay to ensure LVGL is fully ready
                        
                        auto *canvas = id(chart_temperature);
                        if (!canvas) {
                          ESP_LOGE("canvas", "Canvas is null!");
                          return;
                        }
                        ESP_LOGI("canvas", "Canvas object found");
                        
                        ESP_LOGI("canvas", "Calculating buffer size");
                        size_t buf_size = 248 * 165 * sizeof(lv_color_t);
                        ESP_LOGI("canvas", "Buffer size: %d bytes", buf_size);
                        
                        static lv_color_t *buf = nullptr;
                        
                        if (!buf) {
                          ESP_LOGI("canvas", "Allocating canvas buffer");
                          buf = (lv_color_t*)lv_mem_alloc(buf_size);
                          if (!buf) {
                            ESP_LOGE("canvas", "Failed to allocate canvas buffer!");
                            return;
                          }
                          ESP_LOGI("canvas", "Canvas buffer allocated successfully");
                        } else {
                          ESP_LOGI("canvas", "Canvas buffer already allocated");
                        }
                        
                        ESP_LOGI("canvas", "Setting canvas buffer");
                        lv_canvas_set_buffer(canvas, buf, 248, 165, LV_IMG_CF_TRUE_COLOR);
                        ESP_LOGI("canvas", "Canvas buffer set");
                        
                        delay(100);
                        
                        ESP_LOGI("canvas", "Clearing canvas");
                        // Clear canvas
                        lv_draw_rect_dsc_t rect_dsc;
                        lv_draw_rect_dsc_init(&rect_dsc);
                        rect_dsc.bg_color = lv_color_hex(0x1a1a1c);
                        lv_canvas_draw_rect(canvas, 0, 0, 248, 165, &rect_dsc);
                        ESP_LOGI("canvas", "Canvas cleared");
                        
                        delay(100);
                        
                        ESP_LOGI("canvas", "Drawing grid lines");
                        // Draw grid
                        lv_draw_line_dsc_t grid_dsc;
                        lv_draw_line_dsc_init(&grid_dsc);
                        grid_dsc.color = lv_color_hex(0x2A2D32);
                        grid_dsc.width = 1;
                        for (int i = 0; i <= 4; i++) {
                          int y = 15 + (i * 135 / 4);
                          lv_point_t pts[2] = {{10, (lv_coord_t)y}, {238, (lv_coord_t)y}};
                          lv_canvas_draw_line(canvas, pts, 2, &grid_dsc);
                        }
                        ESP_LOGI("canvas", "Grid lines drawn");
                        
                        delay(100);
                        
                        ESP_LOGI("canvas", "Invalidating canvas");
                        lv_obj_invalidate(canvas);
                        ESP_LOGI("canvas", "=== Canvas initialization complete ===");
