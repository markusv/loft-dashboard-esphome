esphome:
  name: waveshare-s3-7
  friendly_name: "Waveshare S3 7\""
  min_version: 2024.10.0

esp32:
  board: esp32-s3-devkitc-1
  variant: esp32s3
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_MBEDTLS_CERTIFICATE_BUNDLE: n

logger:
ota:
  - platform: esphome
api:

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "Waveshare-Setup"
    password: "changeme123"

time:
  - platform: sntp
    id: sntp_time
    timezone: Europe/Oslo

interval:
  - interval: 1s
    then:
      - lambda: |-
          auto now = id(sntp_time).now();
          auto *label = id(lbl_clock);
          if (!now.is_valid()) {
            lv_label_set_text(label, "--:--");
          } else {
            auto text = now.strftime("%H:%M");
            lv_label_set_text(label, text.c_str());
          }

psram:
  mode: octal
  speed: 80MHz

# --- MQTT (Homey/HA bridge) ---
mqtt:
  broker: !secret mqtt_host
  username: !secret mqtt_user
  password: !secret mqtt_pass
  discovery: false
  birth_message:
    topic: home/waveshare7/availability
    payload: online
  will_message:
    topic: home/waveshare7/availability
    payload: offline

# --- I2C for GT911 + CH422G ---
i2c:
  sda: GPIO8
  scl: GPIO9
  id: bus_main
  frequency: 400kHz

# --- CH422G IO expander ---
ch422g:
  id: io_ex

# --- Touchscreen (GT911) ---
touchscreen:
  platform: gt911
  id: gt
  interrupt_pin: GPIO4
  reset_pin:
    ch422g: io_ex
    number: 1

# --- Display (Waveshare ESP32-S3 Touch LCD 7") ---
display:
  - platform: mipi_rgb
    id: panel
    model: ESP32-S3-TOUCH-LCD-7-800X480
    enable_pin:
      ch422g: io_ex
      number: 2

# ================================
#           FONTS
# ================================
# Use ESPHome's standard font component (works with LVGL).
font:
  - file: "fonts/fa-solid-900.ttf"
    id: fa_48
    size: 48
    bpp: 4
    # Include only the glyphs we use (TV, Lightbulb, Music)
    glyphs:
      - "\uF26C"
      - "\uF0EB"
      - "\uF0C2"
      - "\uF001"

# ================================
#           LVGL UI
# ================================
lvgl:
  id: ui
  touchscreens: [gt]

  pages:
    - id: page_main
      bg_color: 0x0F1419  # dashboard background
      widgets:
        # Title
        - label:
            id: lbl_clock
            align: top_left
            x: 16
            y: 8
            text_color: 0xC8CDD2
            text: "--:--"

        - label:
            text: "Loft Dashboard"
            align: top_mid
            y: 8
            text_color: 0xC8CDD2
        # -------- Card: Vær --------
        - obj:
            id: card_weather
            width: 220
            height: 360
            x: 40
            y: 80
            bg_color: 0x1A1F26
            border_color: 0x2A2D32
            border_width: 2
            radius: 30
            pad_all: 20
            widgets:
              - label:
                  text: "Vær"
                  align: top_mid
                  y: 10
                  text_color: 0xFFFFFF
              - label:
                  text: "\uF0C2"   # Font Awesome cloud icon
                  align: center
                  y: -20
                  text_color: 0xD5D9DE
                  text_font: fa_48
              - label:
                  text: "Delvis skyet"
                  align: center
                  y: 50
                  text_color: 0xC8CDD2
              - label:
                  text: "12°"
                  align: bottom_mid
                  y: -10
                  text_color: 0xFFFFFF

        # -------- Card: Stemninger --------
        - obj:
            id: card_stemninger
            width: 220
            height: 360
            x: 300
            y: 80
            bg_color: 0x1A1F26
            border_color: 0x2A2D32
            border_width: 2
            radius: 30
            pad_top: 20
            pad_bottom: 20
            pad_left: 16
            pad_right: 16
            widgets:
              - label:
                  text: "Stemninger"
                  align: top_mid
                  text_color: 0xFFFFFF
              # -------- Button: TV --------
              - button:
                  id: btn_tv
                  width: 180
                  height: 80
                  align: top_mid
                  y: 110
                  bg_color: 0x24282E       # card bg
                  border_color: 0x2A2D32   # card border
                  border_width: 2
                  radius: 20
                  on_click:
                    - mqtt.publish:
                        topic: home/lpft/tv/toggle
                        payload: "toggle"
                  widgets:
                    - label:
                        text: "\uF26C"     # Font Awesome TV
                        text_font: fa_48
                        text_color: 0xFFFFFF
                        align: center
                        y: -10
                    - label:
                        text: "TV"
                        text_color: 0xC8CDD2
                        align: bottom_mid
                        y: -8
              # -------- Button: Kveld (scene) --------
              - button:
                  id: btn_kveld
                  width: 180
                  height: 80
                  align: top_mid
                  y: 205
                  bg_color: 0x24282E
                  border_color: 0x2A2D32
                  border_width: 2
                  radius: 20
                  on_click:
                    - mqtt.publish:
                        topic: home/lpft/scene/kveld
                        payload: "on"
                  widgets:
                    - label:
                        text: "\uF0EB"     # Font Awesome Lightbulb
                        text_font: fa_48
                        text_color: 0xFFFFFF
                        align: center
                        y: -10
                    - label:
                        text: "Kveld"
                        text_color: 0xC8CDD2
                        align: bottom_mid
                        y: -8
              # -------- Button: Lys (light toggle) --------
              - button:
                  id: btn_lys
                  width: 180
                  height: 80
                  align: top_mid
                  y: 300
                  bg_color: 0x24282E
                  border_color: 0x2A2D32
                  border_width: 2
                  radius: 20
                  on_click:
                    - mqtt.publish:
                        topic: home/lpft/light/toggle
                        payload: "toggle"
                  widgets:
                    - label:
                        text: "\uF001"     # Font Awesome Music (change if you want)
                        text_font: fa_48
                        text_color: 0xFFFFFF
                        align: center
                        y: -10
                    - label:
                        text: "Lys"
                        text_color: 0xC8CDD2
                        align: bottom_mid
                        y: -8

        # -------- Card: Enheter --------
        - obj:
            id: card_devices
            width: 220
            height: 360
            x: 560
            y: 80
            bg_color: 0x1A1F26
            border_color: 0x2A2D32
            border_width: 2
            radius: 30
            pad_all: 24
            widgets:
              - label:
                  text: "Enheter"
                  align: top_mid
                  text_color: 0xFFFFFF
              - label:
                  text: "Rullegardin"
                  align: top_left
                  x: 0
                  y: 70
                  text_color: 0xC8CDD2
              - label:
                  text: "Sonos"
                  align: top_left
                  x: 0
                  y: 120
                  text_color: 0xC8CDD2
              - label:
                  text: "Temperatur"
                  align: top_left
                  x: 0
                  y: 170
                  text_color: 0xC8CDD2
              - label:
                  text: "21,0°"
                  align: top_left
                  x: 0
                  y: 220
                  text_color: 0xFFFFFF
