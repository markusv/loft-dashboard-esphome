esphome:
  name: waveshare-s3-7
  friendly_name: 'Waveshare S3 7"'
  min_version: 2024.10.0
  compile_process_limit: 1
  platformio_options:
    platform: espressif32

  # Useful if you ever need to slow down LVGL repaint while testing
  # platformio_options:
  #   board_build.flash_mode: dio

esp32:
  board: esp32-s3-devkitc-1
  variant: esp32s3
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_MBEDTLS_CERTIFICATE_BUNDLE: n

# --- Basics ---
logger:
ota:
  - platform: esphome
api:  # keep if you also want HA native API besides MQTT
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  # Optional for first flash via USB when no Wi-Fi yet:
  ap:
    ssid: "Waveshare-Setup"
    password: "changeme123"
psram:
  mode: octal     # S3 modules with 8MB PSRAM are usually octal
  speed: 80MHz

# --- MQTT for Homey/Home Assistant bridge ---
mqtt:
  broker: !secret mqtt_host
  username: !secret mqtt_user
  password: !secret mqtt_pass
  id: mqtt_main
  discovery: false   # Homey doesn’t use HA discovery
  birth_message:
    topic: home/waveshare7/availability
    payload: online
  will_message:
    topic: home/waveshare7/availability
    payload: offline

# --- I2C bus (used by GT911 touch + CH422G IO expander on this board) ---
i2c:
  sda: GPIO8
  scl: GPIO9
  id: bus_main
  frequency: 400kHz

# --- CH422G IO expander (controls display enable on EXIO2) ---
ch422g:
  id: io_ex



# --- GT911 capacitive touch (interrupt on GPIO4, reset via expander EXIO1) ---
touchscreen:
  platform: gt911
  id: gt
  interrupt_pin: GPIO4
  # Touch reset is wired to CH422G EXIO1 on this board
  reset_pin:
    ch422g: io_ex
    number: 1
  transform:
    swap_xy: false
    mirror_x: false
    mirror_y: false

# --- RGB (parallel) display + LVGL ---
# This board uses a 16-bit RGB interface (no SPI to the panel on A-revision),
# and the expander’s EXIO2 pin is used to enable the backlight/disp power.
display:
  - platform: mipi_rgb
    id: panel
    model: ESP32-S3-TOUCH-LCD-7-800X480
    
    # Use expander to power/enable display
    enable_pin:
      ch422g: io_ex
      number: 2

# --- LVGL wiring to the touchscreen and a tiny demo UI that publishes MQTT ---
lvgl:
  id: ui
  touchscreens: [gt]
  # Avoid setting buffer %, let ESPHome pick defaults for stability

  # Simple single-page layout: three buttons that publish MQTT toggles
  pages:
    - id: page_main
      widgets:
        # Title
        - label:
            text: "Loft Dashboard"
            align: top_mid
            y: 8
            
        # Three big buttons
        - button:
            id: btn_tv
            width: 220
            height: 100
            x: 70
            y: 120
            on_click:
              - mqtt.publish:
                  topic: home/lpft/tv/toggle
                  payload: "toggle"
            widgets:
              - label:
                  text: "TV"
                  
        - button:
            id: btn_kveld
            width: 220
            height: 100
            x: 290
            y: 120
            on_click:
              - mqtt.publish:
                  topic: home/lpft/scene/kveld
                  payload: "on"
            widgets:
              - label:
                  text: "Kveld"
                  
        - button:
            id: btn_lys
            width: 220
            height: 100
            x: 510
            y: 120
            on_click:
              - mqtt.publish:
                  topic: home/lpft/light/toggle
                  payload: "toggle"
            widgets:
              - label:
                  text: "Lys"
                  

  # Using default LVGL fonts to avoid external file dependencies

